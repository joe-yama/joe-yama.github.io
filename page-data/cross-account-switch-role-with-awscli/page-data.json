{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/cross-account-switch-role-with-awscli/",
    "result": {"data":{"site":{"siteMetadata":{"title":"BrainDumper"}},"markdownRemark":{"id":"827e9c33-17de-5d2d-b31f-be6ae068f536","excerpt":"モチベーション 私の使っているAWS環境では諸事情によりOrganizationsが使用できないので、AWSアカウント管理は以下のように行っています。 アイデンティティアカウントにのみIAM Userを作成する アイデンティティアカウントには原則IAM関係のリソースしか作成しない アイデンティティアカウント以外のAWS…","html":"<h2 id=\"モチベーション\" style=\"position:relative;\"><a href=\"#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\" aria-label=\"モチベーション permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>モチベーション</h2>\n<p>私の使っているAWS環境では諸事情によりOrganizationsが使用できないので、AWSアカウント管理は以下のように行っています。</p>\n<ul>\n<li><strong>アイデンティティアカウント</strong>にのみIAM Userを作成する\n<ul>\n<li>アイデンティティアカウントには原則IAM関係のリソースしか作成しない</li>\n</ul>\n</li>\n<li>アイデンティティアカウント以外のAWSアカウント（子アカウントと呼んでいます）にはIAM Userは作成しない\n<ul>\n<li>子アカウントにはIAM Roleを作成し、アイデンティティアカウントからスイッチロールして開発を行う</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 489px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/a3d83a10c1bf82aff1f3bf1e47ccbb16/03e1f/architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACQUlEQVQoz5WRW0sUYRjH/7Ou7qld23WVPaA7+747u3mY951xtTzM+85sadAJVygoIaEDgZd9gC6D8LKgrrzqoi8goUEHS+oiygsLTyjuXqTkBwiKmBhNkO564Ll8fs//AMrlR8pFH2Gij3BhUC5KlEuTMDGomY7eZ1/KL7xdbCiVK/eKpvOEctFFuRzQmDBKupUqMpEkXMYpE42ECQ7KRZFymSVMnCBcaJTLjrxu6QXD7gIQ/PXzB1zXBYAwgOOEiYLaM1yM9VZygZOjapvpFEq6lSgwAcIEBWHSR7kE4QJ53UJeH85cuHw9/ODhDObmX6Rqtdrkp89LN5aXv9za2/t+Znpi0jf+ftG/ciyd/ao0n3KBwGw4hXj5NCiXBU9hOMsr0HsGoDER0ZhV5gOjWdf9jedz8+l6vT61tr4xtbKyendtbb0KQDl/9WZ4JknsZ9Hs2NPmdtVFI4L9I55CDyhDnbqF1t4K2g27JdI/kk8Ydtrz+PrlK2xvb+9b9nZzcxOZVg0tiClx08lAXMxg6FwErosiE564A2CofwReSkv+RMNCoLVjNpKOrsY78Ob+tLK7u9NQvXY7Oj5xJ7q7883nRxjtCCJuOsDZK4AzhpTpKITLA8uEiRCcKj40JbGFWOBdU3JwQ4m1PU6oeJRQkTXs/Vi89Y6q+TK6eyzw7iFFY0Ip6RYIl0eAXIa8hrp1y5fjMtepW0TlkuS4DKp/yzoE0oMj/DuUC4UeBXr0nGF7pTSmTMdPmWgq6dbh9/8C/gGNsKMJpFYvdAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"my aws account architectute\"\n        title=\"my aws account architectute\"\n        src=\"/blog/static/a3d83a10c1bf82aff1f3bf1e47ccbb16/03e1f/architecture.png\"\n        srcset=\"/blog/static/a3d83a10c1bf82aff1f3bf1e47ccbb16/c26ae/architecture.png 158w,\n/blog/static/a3d83a10c1bf82aff1f3bf1e47ccbb16/6bdcf/architecture.png 315w,\n/blog/static/a3d83a10c1bf82aff1f3bf1e47ccbb16/03e1f/architecture.png 489w\"\n        sizes=\"(max-width: 489px) 100vw, 489px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>子アカウントで作業を行うためには毎回スイッチロールが必要になるのです。これがけっこう手間で面倒だったので対応を調べました。</p>\n<h2 id=\"スイッチロールをシームレスに行う\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E3%82%B7%E3%83%BC%E3%83%A0%E3%83%AC%E3%82%B9%E3%81%AB%E8%A1%8C%E3%81%86\" aria-label=\"スイッチロールをシームレスに行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スイッチロールをシームレスに行う</h2>\n<p>AWS CLIでは <code class=\"language-text\">--profile</code> オプションを使用することで、プロファイルを指定してコマンドを実行することができます。</p>\n<p>これは <code class=\"language-text\">.aws/credential</code> に複数のアクセスキーを記載しているときに、どのアクセスキーを使用するかを選ぶためだけにあると思っていました。</p>\n<p>以下のように、 <code class=\"language-text\">.aws/config</code> でうまく設定することで、 <code class=\"language-text\">--profile</code> オプションを指定するだけで、スイッチロールを意識することなく子アカウントでの作業ができることがわかりました。</p>\n<h3 id=\"awscredentialsにアイデンティティアカウントの認証情報を記述する\" style=\"position:relative;\"><a href=\"#awscredentials%E3%81%AB%E3%82%A2%E3%82%A4%E3%83%87%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E8%AA%8D%E8%A8%BC%E6%83%85%E5%A0%B1%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B\" aria-label=\"awscredentialsにアイデンティティアカウントの認証情報を記述する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>①<code class=\"language-text\">.aws/credentials</code>にアイデンティティアカウントの認証情報を記述する</h3>\n\n        <div class=\"gatsby-code-title\">\n          <span>~/.aws/credential</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">identity-account</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">aws_access_key_id</span> <span class=\"token punctuation\">=</span> &lt;your access key id>\n<span class=\"token key property\">aws_secret_access_key</span> <span class=\"token punctuation\">=</span> &lt;your secret access key></code></pre></div>\n<h3 id=\"awsconfigにスイッチロールする際の設定を記述する\" style=\"position:relative;\"><a href=\"#awsconfig%E3%81%AB%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E9%9A%9B%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B\" aria-label=\"awsconfigにスイッチロールする際の設定を記述する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>②<code class=\"language-text\">.aws/config</code>にスイッチロールする際の設定を記述する</h3>\n<p>アイデンティティアカウントにMFA設定がある場合は、<code class=\"language-text\">mfa_serial</code>（ハイライト行）にMFAデバイスのARNを記載してください。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>~/.aws/config</span>\n        </div>\n       \n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span>profile identity-account<span class=\"token punctuation\">]</span> <span class=\"token comment\"># アイデンティティアカウントの設定</span>\n<span class=\"token key property\">region</span> <span class=\"token punctuation\">=</span> ap-northeast<span class=\"token number\">-1</span>\n<span class=\"token key property\">output</span> <span class=\"token punctuation\">=</span> json\n\n<span class=\"token punctuation\">[</span>profile dev-account<span class=\"token punctuation\">]</span> <span class=\"token comment\"># プロファイル名は任意</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token key property\">mfa_serial</span> <span class=\"token punctuation\">=</span> arn:aws:iam::<span class=\"token number\">123456789</span>:mfa/your-mfa-device <span class=\"token comment\"># 自分のMFAデバイスのARN</span></span><span class=\"token key property\">role_arn</span> <span class=\"token punctuation\">=</span> arn:aws:iam::<span class=\"token number\">987654321</span>:role/dev-account-role <span class=\"token comment\"># スイッチしたい子アカウントのRole</span>\n<span class=\"token key property\">source_profile</span> <span class=\"token punctuation\">=</span> identity-account <span class=\"token comment\"># ①で設定したアイデンティティアカウントのプロファイル名</span>\n<span class=\"token key property\">region</span> <span class=\"token punctuation\">=</span> ap-northeast<span class=\"token number\">-1</span>\n<span class=\"token key property\">output</span> <span class=\"token punctuation\">=</span> json</code></pre></div>\n<p>これで設定は完了です。</p>\n<h3 id=\"プロファイルを指定してcliを実行する\" style=\"position:relative;\"><a href=\"#%E3%83%97%E3%83%AD%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6cli%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"プロファイルを指定してcliを実行する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>③プロファイルを指定してCLIを実行する</h3>\n<p>もうスイッチロールを意識せずとも、プロファイルを指定するだけで子アカウントのRoleでCLIを実行できます。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>bash</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws sts get-caller-identity --profile dev-account\nEnter MFA code <span class=\"token keyword\">for</span> arn:aws:iam::123456789:mfa/your-mfa-device: <span class=\"token number\">123456</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"UserId\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ARXXXXXXXXXXXXXXXX:botocore-session-1111111111\"</span>,\n    <span class=\"token string\">\"Account\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"987654321\"</span>,\n    <span class=\"token string\">\"Arn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:sts::987654321:assumed-role/dev-account-role/botocore-session-1111111111\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>初回はMFAコードを求められますが、2回目以降はstsの有効期限が切れるまでMFAコードは聞かれなくなります。</p>","frontmatter":{"title":"AWS CLIでクロスアカウントのスイッチロールを行う","date":"April 02, 2022","description":".aws/configに何を書けば良いんだっけ？と思ったときのための備忘録"}},"previous":{"fields":{"slug":"/how-to-create-this-blog/"},"frontmatter":{"title":"このブログをはじめるにあたって"}},"next":{"fields":{"slug":"/remap-handmade-keyboard/"},"frontmatter":{"title":"自作キーボードのキーマップを変更する"}}},"pageContext":{"id":"827e9c33-17de-5d2d-b31f-be6ae068f536","previousPostId":"5e2bf39a-66d9-543c-880b-27d4db8d3444","nextPostId":"f792b167-8930-5df7-9622-25935eda252e"}},
    "staticQueryHashes": ["2841359383","3257411868"]}