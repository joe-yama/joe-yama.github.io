{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/sharing-wedding-movie-via-s3/",
    "result": {"data":{"site":{"siteMetadata":{"title":"BrainDumper"}},"markdownRemark":{"id":"53dee3c9-4bf2-51da-b2b4-5e70b65eb9ea","excerpt":"友人の結婚式で動画を撮りまくっていたら、合計10GBを超えてしまっていました。（最近カメラを買ったので、、、）\nGoogleフォトに保存して共有すればいいや、と楽観視していましたが問題発生。 Googleフォトに無料で保存できるのは1アカウント15GB…","html":"<p>友人の結婚式で動画を撮りまくっていたら、合計10GBを超えてしまっていました。（最近カメラを買ったので、、、）\nGoogleフォトに保存して共有すればいいや、と楽観視していましたが問題発生。</p>\n<p><a href=\"https://support.google.com/photos/answer/6220791?hl=ja\">Googleフォトに無料で保存できるのは1アカウント15GBまで</a>というのを忘れていました。\nすでに使用している容量と合計すると15GBを超えてしますので、別途Google Oneでデータ容量を購入する必要がありそうです。</p>\n<p>そこで、プライベートで撮りためた動画・写真を低コストで保管・共有するためにS3が活用できないかを考えてみましたので、ここに記録しておきます。</p>\n<h2 id=\"s3はプライベート動画の保存先として適しているのか\" style=\"position:relative;\"><a href=\"#s3%E3%81%AF%E3%83%97%E3%83%A9%E3%82%A4%E3%83%99%E3%83%BC%E3%83%88%E5%8B%95%E7%94%BB%E3%81%AE%E4%BF%9D%E5%AD%98%E5%85%88%E3%81%A8%E3%81%97%E3%81%A6%E9%81%A9%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B\" aria-label=\"s3はプライベート動画の保存先として適しているのか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>S3はプライベート動画の保存先として適しているのか？</h2>\n<p>プライベート動画を保存するために満たしたい条件はざっくり以下の3つでした。</p>\n<ol>\n<li>データが失われない</li>\n<li>低コスト</li>\n<li>共有が容易</li>\n</ol>\n<p>S3はこれらの条件を満たすことができるのかを書いていきます。</p>\n<h3 id=\"1-データが失われない\" style=\"position:relative;\"><a href=\"#1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%A4%B1%E3%82%8F%E3%82%8C%E3%81%AA%E3%81%84\" aria-label=\"1 データが失われない permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. データが失われない</h3>\n<p>ご存知の通りS3は複数のアベイラビリティーゾーンにわたってオブジェクトの耐久性が99.999999999%を達成するように設計されています。\n自宅PCや自宅のNASで保管する場合は物理的にデバイスが壊れてしまうと、いままでの思い出がすべて消えてしまいます。自前でRAIDを組むなどしておけば、ある程度は安心ですが、地震が発生してRAIDごとすべて破壊されてしまう、といったことは防げません。</p>\n<h3 id=\"2-低コスト\" style=\"position:relative;\"><a href=\"#2-%E4%BD%8E%E3%82%B3%E3%82%B9%E3%83%88\" aria-label=\"2 低コスト permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 低コスト</h3>\n<p>動画の保存場所なのでそこまでのレイテンシや可用性は求めませんが、コストはなるべく低く抑えたいです。S3のストレージ料金を抑えるためには、<a href=\"https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/intelligent-tiering-overview.html\">S3 Intelligent-Tiering</a>を活用するとよいようです。</p>\n<p>Intelligent-Tieringはオブジェクトの使用頻度に応じて自動で最適なストレージクラスに移動してくれるサービスですが、取り出し料金が無料というメリットもあります。</p>\n<blockquote>\n<p>S3 Intelligent-Tiering には取り出し料金は発生しません。低頻度アクセス階層またはアーカイブインスタントアクセス階層にあるオブジェクトに後でアクセスすると、そのオブジェクトは高頻度アクセス階層に自動的に戻されます。<br>\n引用元：<a href=\"https://aws.amazon.com/jp/s3/storage-classes/\">Amazon S3 ストレージクラス</a></p>\n</blockquote>\n<h4 id=\"参考googleフォトとのコスト比較\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83google%E3%83%95%E3%82%A9%E3%83%88%E3%81%A8%E3%81%AE%E3%82%B3%E3%82%B9%E3%83%88%E6%AF%94%E8%BC%83\" aria-label=\"参考googleフォトとのコスト比較 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考：Googleフォトとのコスト比較</h4>\n<p>ストレージ料金だけでの比較になりますが、Googleフォトとのコスト比較をしてみます。\nGoogleフォトは15GBまで無料で、それ以上になるとGoogle Oneというストレージサービスを契約する必要があります。これは100GBのベーシックというプランで月額250円です。</p>\n<p>一方でS3のストレージ料金を試算してみます。定常状態では、以下のようなTeiringになっていると仮定します。</p>\n<ul>\n<li>合計100GB</li>\n<li>10%が高頻度アクセスティア</li>\n<li>10%が低頻度アクセスティア</li>\n<li>30%がアーカイブインスタントアクセスティア</li>\n<li>50%がアーカイブアクセスティア</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th align=\"center\">ティア</th>\n<th align=\"right\">容量</th>\n<th align=\"right\">ストレージ料金/月</th>\n<th align=\"right\">料金</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">高頻度アクセス</td>\n<td align=\"right\">10GB</td>\n<td align=\"right\">0.025USD/GB</td>\n<td align=\"right\">0.25USD</td>\n</tr>\n<tr>\n<td align=\"center\">低頻度アクセス</td>\n<td align=\"right\">10GB</td>\n<td align=\"right\">0.0138USD/GB</td>\n<td align=\"right\">0.138USD</td>\n</tr>\n<tr>\n<td align=\"center\">アーカイブインスタントアクセス</td>\n<td align=\"right\">30GB</td>\n<td align=\"right\">0.005USD/GB</td>\n<td align=\"right\">0.15USD</td>\n</tr>\n<tr>\n<td align=\"center\">アーカイブアクセス</td>\n<td align=\"right\">50GB</td>\n<td align=\"right\">0.0045USD/GB</td>\n<td align=\"right\">0.225USD</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>合計</strong></td>\n<td align=\"right\"><strong>100GB</strong></td>\n<td align=\"right\">-</td>\n<td align=\"right\"><strong>0.763USD</strong><br>(約90円)</td>\n</tr>\n</tbody>\n</table>\n<p>以上より、100GBあたりの料金で比較すると、<strong>Googleフォトは月額250円、S3は月額90円となり、S3のほうが2.5倍ほど安価</strong>になることがわかりました。</p>\n<p>ただし、S3では、ストレージ料金に加えてデータ転送量（100GB/月までは無料）や、モニタリング料金（無視できるほど少額）や、リクエスト回数に応じた料金（無視できるほど少額）が発生するので注意が必要です。とはいえ、通常は無視できるような金額と思います。</p>\n<h3 id=\"3-共有が容易\" style=\"position:relative;\"><a href=\"#3-%E5%85%B1%E6%9C%89%E3%81%8C%E5%AE%B9%E6%98%93\" aria-label=\"3 共有が容易 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 共有が容易</h3>\n<p>耐久性とかコストとかの面でS3が優れていることはまあ当然といえば当然です。\n果たして疑問なのが、簡単に友人に動画を共有できるかという点でしたが、署名付きURLを発行すれば、簡単かつ安全に動画を友人に共有できることがわかりました。</p>\n<p>もちろんURLにアクセスするだけなので、非AWSユーザーにも簡単に共有できます。</p>\n<h3 id=\"署名付きurlを利用した動画の共有方法\" style=\"position:relative;\"><a href=\"#%E7%BD%B2%E5%90%8D%E4%BB%98%E3%81%8Durl%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E5%8B%95%E7%94%BB%E3%81%AE%E5%85%B1%E6%9C%89%E6%96%B9%E6%B3%95\" aria-label=\"署名付きurlを利用した動画の共有方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>署名付きURLを利用した動画の共有方法</h3>\n<p>プライベートの動画ですからパブリックに公開して共有、なんてしたくありません。そこで<a href=\"https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html\">S3の署名付きURL</a>を利用します。</p>\n<p>適当にバケットを作成して、動画をアップロードします。</p>\n<p>面倒なのですが、その性質上オブジェクトごとに署名付きURLを発行する必要があるので、指定のPrefixにあるオブジェクトすべての事前署名付きURLを発行し、テキストに保存します。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>bash</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws s3 <span class=\"token function\">ls</span> --recursive s3://my-s3-bucket/2022-04-23-結婚式/ <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $NF}'</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> -I <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> aws s3 presign s3://my-s3-bucket/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> --expires-in <span class=\"token number\">604800</span> <span class=\"token operator\">></span> presign-urls.txt</code></pre></div>\n<p>あとは<code class=\"language-text\">presign-urls.txt</code>を友人に共有すればOKです。</p>\n<p><code class=\"language-text\">--expires-in</code>で署名が失効するまでの時間（秒単位）を指定することができます。最大は604800（1週間）のようです。<strong>（←ハマリポイントあり。追記参照）</strong></p>\n<h3 id=\"追記署名付き-url-が指定した有効期限より前に失効してしまう\" style=\"position:relative;\"><a href=\"#%E8%BF%BD%E8%A8%98%E7%BD%B2%E5%90%8D%E4%BB%98%E3%81%8D-url-%E3%81%8C%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%88%E3%82%8A%E5%89%8D%E3%81%AB%E5%A4%B1%E5%8A%B9%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86\" aria-label=\"追記署名付き url が指定した有効期限より前に失効してしまう permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>追記：署名付き URL が指定した有効期限より前に失効してしまう</h3>\n<p>友人に共有したURLからダウンロードしてもらいたいので、URLの有効期限（<code class=\"language-text\">expires-in</code>）は最大値の１週間を設定していました。\nですが、次の日URLが無効になっていると友人連絡がありました。</p>\n<p>URL先ではこんな表示が。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Code</span><span class=\"token punctuation\">></span></span>AccessDenied<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Code</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Message</span><span class=\"token punctuation\">></span></span>Request has expired<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Message</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>1週間の有効期限を設定したのに翌日に期限切れになってしまってます。</p>\n<h4 id=\"原因\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E5%9B%A0\" aria-label=\"原因 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因</h4>\n<p>AWSのナレッジセンターに以下のような記事を見つけました。</p>\n<blockquote>\n<p>一時トークンを使用して署名済み URL を作成した場合は、トークンが失効すると URL も失効します。それより後の有効期限を指定して URL を作成した場合でも、URL は失効します。<br>\n<a href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/presigned-url-s3-bucket-expiration/\">Amazon S3 バケットの署名付き URL が、指定した有効期限より前に失効するのはなぜですか?</a></p>\n</blockquote>\n<p>署名付きURLを発行したのはIAM Roleだったので、AssumeRoleしたときの一時トークンの有効期限が過ぎてしまうと、事前署名付きURLも執行してしまうようです。</p>\n<p>AssumeRoleの一時トークンの有効期限はというと、デフォルトでは1時間（最大でも12時間）とのこと。</p>\n<blockquote>\n<p>パラメータを渡さない場合、一時的な認証情報の有効期限は 1 時間です。<br>\n<a href=\"https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_credentials_temp_request.html\">AssumeRole—クロスアカウントの委任とカスタム ID ブローカーを経由したフェデレーション</a></p>\n</blockquote>\n<p>したがって、IAM RoleをPrincipalが事前署名する場合、12時間以上の有効期限は実質設定不可能なのです。</p>\n<h4 id=\"対処法\" style=\"position:relative;\"><a href=\"#%E5%AF%BE%E5%87%A6%E6%B3%95\" aria-label=\"対処法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>対処法</h4>\n<p>これもナレッジセンターに書かれていました。</p>\n<blockquote>\n<p>最長 7 日間有効の署名付き URL を作成するには、SDK に対する IAM ユーザー認証情報 (アクセスキーとシークレットアクセスキー) を指定します。その後、AWS 署名バージョン 4 を使用して署名付き URL を生成します。<br>\n<a href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/presigned-url-s3-bucket-expiration/\">Amazon S3 バケットの署名付き URL が、指定した有効期限より前に失効するのはなぜですか?</a></p>\n</blockquote>\n<p>最長 7 日間有効の署名付き URL を作成するには、IAMユーザーが署名する必要があるようです。</p>\n<p>事前署名付きURL発行の仕組みを考慮すれば確かにそうなるのですが、ハマリポイントなので注意です。</p>","frontmatter":{"title":"Googleフォトの半分以下のコストで動画を保管・共有する","date":"April 27, 2022","description":"プライベート動画をS3に保存するメリットと、非AWSユーザーの友人に共有する方法。"}},"previous":{"fields":{"slug":"/remap-handmade-keyboard/"},"frontmatter":{"title":"自作キーボードのキーマップを変更する"}},"next":{"fields":{"slug":"/introduce-my-keyboard/"},"frontmatter":{"title":"自作キーボードChoco60 rev.2に最適なセッティング"}}},"pageContext":{"id":"53dee3c9-4bf2-51da-b2b4-5e70b65eb9ea","previousPostId":"f792b167-8930-5df7-9622-25935eda252e","nextPostId":"0342e1af-2f31-5de3-94df-f0d14c085ce8"}},
    "staticQueryHashes": ["2841359383","3257411868"]}